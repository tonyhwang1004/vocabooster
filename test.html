<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>단어 테스트 - VocaBooster</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            font-family: 'Pretendard', 'Apple SD Gothic Neo', sans-serif;
            background-color: #edf2f7;
            color: #1a202c;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 0 15px;
        }
        .timer-box {
            text-align: center;
            margin-bottom: 20px;
        }
        .timer {
            display: inline-flex;
            align-items: center;
            background-color: white;
            border-radius: 30px;
            padding: 8px 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-weight: bold;
            color: #4361ee;
        }
        .timer-icon {
            margin-right: 8px;
        }
        .progress-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 14px;
            color: #4a5568;
        }
        .progress {
            height: 8px;
            margin-bottom: 20px;
            background-color: #e2e8f0;
            border-radius: 4px;
        }
        .progress-bar {
            background-color: #4361ee;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .question-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 25px;
            margin-bottom: 20px;
            display: none;
        }
        .question-card.active {
            display: block;
        }
        .question-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .question-number {
            font-size: 16px;
            font-weight: bold;
            color: #4361ee;
            background-color: rgba(67, 97, 238, 0.1);
            padding: 5px 15px;
            border-radius: 20px;
        }
        .question-type {
            font-size: 14px;
            color: #5a67d8;
            background-color: rgba(90, 103, 216, 0.1);
            padding: 5px 12px;
            border-radius: 20px;
        }
        .question-text {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            padding: 30px 20px;
            margin-bottom: 20px;
            background-color: #f7fafc;
            border-radius: 8px;
        }
        .answer-input {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            text-align: center;
            transition: all 0.3s ease;
        }
        .answer-input:focus {
            outline: none;
            border-color: #4361ee;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }
        .options-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        .option-button {
            padding: 12px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background-color: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 16px;
        }
        .option-button:hover {
            border-color: #4361ee;
            background-color: rgba(67, 97, 238, 0.05);
        }
        .option-button.selected {
            border-color: #4361ee;
            background-color: rgba(67, 97, 238, 0.1);
            font-weight: bold;
        }
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .nav-button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .prev-button {
            background-color: #e2e8f0;
            color: #4a5568;
        }
        .prev-button:hover {
            background-color: #cbd5e0;
        }
        .next-button {
            background-color: #4361ee;
            color: white;
        }
        .next-button:hover {
            background-color: #3845c7;
        }
        .submit-button {
            display: block;
            width: 100%;
            padding: 15px;
            background-color: #4361ee;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        .submit-button:hover {
            background-color: #3845c7;
        }
        .keyboard-shortcuts {
            text-align: center;
            margin-top: 20px;
            color: #718096;
            font-size: 14px;
        }
        .key {
            display: inline-block;
            padding: 2px 8px;
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin: 0 3px;
        }
        #loadingOverlay {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .loader {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top-color: #4361ee;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loading-text {
            color: white;
            margin-top: 20px;
            font-size: 18px;
        }
        .student-info {
            text-align: center;
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            font-size: 14px;
            color: #4a5568;
        }
        .warning-message {
            background-color: #fff8e6;
            border: 1px solid #f6e05e;
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #b7791f;
        }
    </style>
</head>
<body>
    <!-- 로딩 오버레이 -->
    <div id="loadingOverlay">
        <div class="loader"></div>
        <div class="loading-text">단어 데이터 로딩 중...</div>
    </div>

    <div class="container">
        <!-- 학생 정보 -->
        <div class="student-info">
            <strong id="studentName"></strong> | <span id="bookName"></span> | <span id="testModeText"></span>
        </div>

        <!-- 타이머 -->
        <div class="timer-box">
            <div class="timer">
                <i class="bi bi-clock timer-icon"></i>
                <span id="timer">00:00</span>
            </div>
        </div>

        <!-- 진행 상황 -->
        <div class="progress-container">
            <div>문제 <span id="currentQuestion">1</span>/<span id="totalQuestions">0</span></div>
            <div>진행률: <span id="progressPercent">0%</span></div>
        </div>
        <div class="progress">
            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
        </div>

        <!-- 문제 영역 -->
        <div id="questionsContainer"></div>

        <!-- 제출 버튼 -->
        <button class="submit-button" id="submitBtn" style="display: none;">
            <i class="bi bi-check-circle"></i> 테스트 제출
        </button>

        <!-- 키보드 단축키 안내 -->
        <div class="keyboard-shortcuts">
            <span class="key">←</span> 이전 | <span class="key">→</span> 다음 | <span class="key">Enter</span> 다음/제출
        </div>
    </div>

    <script>
        // GitHub Pages 기본 경로 설정
        function getBasePath() {
            const pathname = window.location.pathname;
            if (pathname.endsWith('.html')) {
                return pathname.substring(0, pathname.lastIndexOf('/') + 1);
            }
            return pathname.endsWith('/') ? pathname : pathname + '/';
        }
        const BASE_PATH = getBasePath();

        // URL 파라미터 파싱
        const urlParams = new URLSearchParams(window.location.search);
        const studentName = urlParams.get('name') || '학생';
        const bookName = urlParams.get('book') || '';
        const bookFolder = urlParams.get('folder') || bookName;
        const lessonList = urlParams.get('lessons') ? urlParams.get('lessons').split(',') : [];
        const questionCount = parseInt(urlParams.get('count')) || 40;
        const testMode = urlParams.get('mode') || 'kor_to_eng';

        // 전역 변수
        let questions = [];
        let currentIndex = 0;
        let answers = {};
        let startTime = null;
        let timerInterval = null;

        // 페이지 로드 시
        document.addEventListener('DOMContentLoaded', async function() {
            // 학생 정보 표시
            document.getElementById('studentName').textContent = studentName;
            document.getElementById('bookName').textContent = bookName;
            document.getElementById('testModeText').textContent = testMode === 'kor_to_eng' ? '한→영' : '영→한';

            // 단어 로드
            await loadWords();
        });

        // 단어 데이터 로드
        async function loadWords() {
            try {
                let allWords = [];
                
                console.log('BASE_PATH:', BASE_PATH);
                console.log('Book:', bookName);
                console.log('Folder:', bookFolder);
                console.log('Lessons:', lessonList);

                for (const lesson of lessonList) {
                    // 여러 경로 시도 - bookFolder 사용
                    const pathsToTry = [
                        BASE_PATH + `data/books/${encodeURIComponent(bookFolder)}/${encodeURIComponent(lesson)}.json`,
                        `./data/books/${encodeURIComponent(bookFolder)}/${encodeURIComponent(lesson)}.json`,
                        `/vocabooster/data/books/${encodeURIComponent(bookFolder)}/${encodeURIComponent(lesson)}.json`,
                        BASE_PATH + `data/books/${bookFolder}/${lesson}.json`
                    ];
                    
                    let loaded = false;
                    for (const url of pathsToTry) {
                        try {
                            console.log('Trying URL:', url);
                            const response = await fetch(url);
                            if (response.ok) {
                                const words = await response.json();
                                allWords = allWords.concat(words);
                                console.log('Success! Loaded', words.length, 'words from', url);
                                loaded = true;
                                break;
                            }
                        } catch (e) {
                            console.log('Failed:', url, e.message);
                        }
                    }
                    
                    if (!loaded) {
                        console.warn('Could not load lesson:', lesson);
                    }
                }

                if (allWords.length === 0) {
                    alert('단어 데이터를 불러올 수 없습니다.\n\n콘솔(F12)에서 오류를 확인해주세요.');
                    window.location.href = 'index.html';
                    return;
                }

                // 셔플 및 제한
                allWords = shuffleArray(allWords);
                const count = questionCount === -1 ? allWords.length : Math.min(questionCount, allWords.length);
                allWords = allWords.slice(0, count);

                // 문제 생성
                questions = allWords.map((word, i) => {
                    const question = testMode === 'kor_to_eng' ? word.kor : word.eng;
                    const answer = testMode === 'kor_to_eng' ? word.eng : word.kor;
                    return {
                        index: i + 1,
                        question: question,
                        answer: answer,
                        originalWord: word
                    };
                });

                // UI 렌더링
                renderQuestions();
                document.getElementById('loadingOverlay').style.display = 'none';
                startTimer();

            } catch (error) {
                console.error('단어 로드 오류:', error);
                alert('단어 데이터를 불러오는데 실패했습니다.');
            }
        }

        // 배열 셔플
        function shuffleArray(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        // 문제 렌더링
        function renderQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';

            document.getElementById('totalQuestions').textContent = questions.length;

            questions.forEach((q, i) => {
                const card = document.createElement('div');
                card.className = 'question-card' + (i === 0 ? ' active' : '');
                card.id = `question${i + 1}`;

                card.innerHTML = `
                    <div class="question-header">
                        <div class="question-number">문제 ${q.index}</div>
                        <div class="question-type">${testMode === 'kor_to_eng' ? '한 → 영' : '영 → 한'}</div>
                    </div>
                    <div class="question-text">${q.question}</div>
                    <div class="warning-message">
                        <i class="bi bi-exclamation-triangle-fill"></i> 주의: 자동단어추천 기능과 맞춤법 검사는 사용이 금지됩니다.
                    </div>
                    <input type="text" class="answer-input" id="answer${i}" 
                           placeholder="정답을 입력하세요" autocomplete="off" autocorrect="off" 
                           autocapitalize="off" spellcheck="false">
                    <div class="nav-buttons">
                        <button type="button" class="nav-button prev-button" onclick="navigateQuestion(-1)" ${i === 0 ? 'disabled' : ''}>
                            <i class="bi bi-arrow-left"></i> 이전
                        </button>
                        <button type="button" class="nav-button next-button" onclick="navigateQuestion(1)">
                            다음 <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                `;

                container.appendChild(card);

                // 입력 이벤트
                const input = card.querySelector('.answer-input');
                input.addEventListener('input', function() {
                    answers[i] = this.value;
                });
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        if (currentIndex < questions.length - 1) {
                            navigateQuestion(1);
                        } else {
                            submitTest();
                        }
                    }
                });
            });

            // 제출 버튼 표시
            document.getElementById('submitBtn').style.display = 'block';
            document.getElementById('submitBtn').onclick = submitTest;

            updateProgress();
        }

        // 문제 이동
        function navigateQuestion(direction) {
            const newIndex = currentIndex + direction;
            if (newIndex < 0 || newIndex >= questions.length) return;

            // 현재 문제 숨기기
            document.getElementById(`question${currentIndex + 1}`).classList.remove('active');
            
            // 새 문제 표시
            currentIndex = newIndex;
            document.getElementById(`question${currentIndex + 1}`).classList.add('active');
            
            // 입력 필드에 포커스
            document.getElementById(`answer${currentIndex}`).focus();
            
            updateProgress();
        }

        // 진행률 업데이트
        function updateProgress() {
            const current = currentIndex + 1;
            const total = questions.length;
            const percent = Math.round((current / total) * 100);

            document.getElementById('currentQuestion').textContent = current;
            document.getElementById('progressPercent').textContent = percent + '%';
            document.getElementById('progressBar').style.width = percent + '%';
        }

        // 타이머 시작
        function startTimer() {
            startTime = new Date();
            timerInterval = setInterval(updateTimer, 1000);
        }

        // 타이머 업데이트
        function updateTimer() {
            const now = new Date();
            const elapsed = Math.floor((now - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('timer').textContent = 
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // 테스트 제출
        function submitTest() {
            if (!confirm('테스트를 제출하시겠습니까?')) return;

            clearInterval(timerInterval);
            const endTime = new Date();
            const totalTime = Math.floor((endTime - startTime) / 1000);

            // 채점
            let correct = 0;
            const results = questions.map((q, i) => {
                const userAnswer = (answers[i] || '').trim().toLowerCase();
                const correctAnswer = q.answer.toLowerCase();
                
                // 정답 체크 (여러 답 허용 - 쉼표로 구분)
                const correctAnswers = correctAnswer.split(',').map(a => a.trim());
                const isCorrect = correctAnswers.some(ans => 
                    userAnswer === ans || 
                    userAnswer.includes(ans) || 
                    ans.includes(userAnswer)
                );

                if (isCorrect) correct++;

                return {
                    question: q.question,
                    userAnswer: answers[i] || '',
                    correctAnswer: q.answer,
                    isCorrect: isCorrect
                };
            });

            const score = Math.round((correct / questions.length) * 100);

            // 결과 저장
            const testResult = {
                name: studentName,
                book: bookName,
                lessons: lessonList.join(', '),
                mode: testMode,
                score: score,
                correct: correct,
                total: questions.length,
                time: totalTime,
                date: new Date().toISOString(),
                details: results
            };

            // localStorage에 저장
            const savedResults = JSON.parse(localStorage.getItem('vocabooster_results') || '[]');
            savedResults.push(testResult);
            localStorage.setItem('vocabooster_results', JSON.stringify(savedResults));

            // 결과 페이지로 이동
            sessionStorage.setItem('currentResult', JSON.stringify(testResult));
            window.location.href = 'result.html';
        }

        // 키보드 단축키
        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowLeft') {
                navigateQuestion(-1);
            } else if (e.key === 'ArrowRight') {
                navigateQuestion(1);
            }
        });
    </script>
</body>
</html>
